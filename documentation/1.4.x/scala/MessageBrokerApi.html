
<!DOCTYPE html>
<html class="noios">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Lagom - Message Broker API</title>
        <meta name="description" content="Lagom">
        
            <link rel="canonical" href="https://www.lagomframework.com/documentation/1.6.x/scala/MessageBrokerApi.html"/>
        
        <meta name="viewport" content="width=device-width,maximum-scale=1"/>
        <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700" rel="stylesheet" type="text/css"/>
        <link rel="stylesheet" href="/fc8a16ee954e5d690ad63c500f4b4e32df567146-all-styles-concat.css" type="text/css">
        <!-- OneTrust Cookies Consent Notice (Production Standard, lagomframework.com, en-GB) start -->
        <script src="https://optanon.blob.core.windows.net/consent/1ee3f0d6-9ed5-4b9e-bed7-ce6faaeaca5d.js" type="text/javascript" charset="UTF-8"></script>
        <script type="text/javascript">
            function OptanonWrapper() { 
                (function($) {
                    $(function() {
                        //find each YT embed and only load if cookies have been approved
                        $( ".yt-widget" ).each(function( index ) {
                            var ytID = $(this).attr("id").slice(3);
                            Optanon.InsertHtml('<iframe id="player" class="youtube-embed-player" src="//www.youtube.com/embed/'+ytID+'?rel=0&amp;autohide=1&amp;modestbranding=0&amp;showinfo=1" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>', 'yt-'+ytID, null, {deleteSelectorContent: true}, 4);
                        });
                    });
                })(jQuery);
            }
        </script>
        <!-- OneTrust Cookies Consent Notice (Production Standard, lagomframework.com, en-GB) end -->
         
    <link rel="stylesheet" href="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" />
    

    </head>
    <body>
        <div class="off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>
                <div class="off-canvas position-left" id="offCanvasLeft" data-off-canvas >
                    <nav>
                        <button class="close-button" aria-label="Close menu" type="button" data-close>
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <a href="/get-started.html">Try Lagom</a>
                        
<h3>Documentation</h3>
<ul>
    <li><a href="/documentation">By release</a></li>
    <li><a href="/faq.html">FAQ</a></li>
    <li><a href="/blog">Team Blog</a></li>
</ul>
<h3>Find Help</h3>
<ul>
    <li><a href="https://gitter.im/lagom/lagom">Gitter channel</a></li>
    <li><a href="https://stackoverflow.com/questions/tagged/lagom">Stack overflow</a></li>
    <li><a href="/support.html">Support</a></li>
</ul>
<h3>Contribute</h3>
<ul>
    <li><a href="/get-involved.html">Get involved</a></li>
    <li><a href="https://www.lightbend.com/conduct">Code of conduct</a></li>
    <li><a href="/community-process.html">Community process</a></li>
    <li><a href="/contributing.html">Contributor guidelines</a></li>
</ul>
<!-- <h3>Programs</h3> Commented out Oct 2017 because the team is not participating in this round of the program.
<ul>
    <li><a href="/outreachy/round14.html">Outreachy</a></li>
</ul> -->

                    </nav>
                </div>
                <div class="off-canvas-content" data-off-canvas-content>

                    
<div id="lightbend-banner" class="lightbend-banner lagom full-width" data-category="OSS Lightbend Banner Impression" data-label="Lagom Banner Impression">
	<div class="wrapper">
		<div class="brand">
			<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Lagom Banner" href="https://www.lightbend.com?r=oss-banner-lagom" target="_blank">
				<img class="lightbend-logo" src="/images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
			</a>
		</div>
		<div class="nav">
			<a class="banner-btn oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Enhance your Lagom services with Akka Platform [Button] - Lagom Banner" href="https://www.lightbend.com/lagom-framework-part-of-akka-platform?r=oss-banner-lagom" target="_blank">
				<span>Enhance your Lagom services with</span>
				<img class="akka-platform-reverse-logo" src="/images/banner-logos/akka-platform-reverse.svg" alt="Akka Platform" title="Akka Platform">
			</a>
			<div class="drop-down">
				<svg class="svg-chevon-circle-down" version="1.1" id="Chevron_circled_down" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
					<path fill="#ffffff" d="M12.505,8.698L10,11L7.494,8.698c-0.198-0.196-0.518-0.196-0.718,0c-0.197,0.196-0.197,0.515,0,0.71l2.864,2.807
					c0.199,0.196,0.52,0.196,0.717,0l2.864-2.807c0.199-0.195,0.198-0.514,0-0.71C13.024,8.502,12.704,8.502,12.505,8.698z M10,0.4
					c-5.302,0-9.6,4.298-9.6,9.6c0,5.303,4.298,9.6,9.6,9.6s9.6-4.297,9.6-9.6C19.6,4.698,15.302,0.4,10,0.4z M10,18.354
					c-4.615,0-8.354-3.74-8.354-8.354c0-4.614,3.739-8.354,8.354-8.354c4.613,0,8.354,3.74,8.354,8.354
					C18.354,14.614,14.613,18.354,10,18.354z" />
				</svg>
				<div class="drop-down-content">
					<div class="lightbend-family">
						<a href="https://akka.io" class="akka oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Akka - Logo Tag Line - Lagom Banner">
							<img class="akka-full-color-logo" src="/images/banner-logos/akka-full-color.svg" alt="Akka by Lightbend" title="Akka by Lightbend">
						</a>
						<a href="https://cloudflow.io" class="cloudflow oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudflow - Logo Tag Line - Lagom Banner">
							<img class="cloudflow-full-color-logo" src="/images/banner-logos/cloudflow-full-color.svg" alt="Cloudflow by Lightbend" title="Cloudflow by Lightbend">
						</a>
						<a href="https://cloudstate.io" class="cloudstate oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudstate - Logo Tag Line - Lagom Banner">
							<img class="cloudstate-full-color-logo" src="/images/banner-logos/cloudstate-full-color.svg" alt="Cloudstate by Lightbend" title="Cloudstate by Lightbend">
						</a>
						<a href="https://www.playframework.com" class="play oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Play - Logo Tag Line - Lagom Banner">
							<img class="play-full-color-logo" src="/images/banner-logos/play-full-color.svg" alt="Play Framework by Lightbend" title="Play Framework by Lightbend">
						</a>
						<a href="https://www.scala-lang.org" class="scala oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Scala - Logo Tag Line - Lagom Banner">
							<img class="scala-full-color-logo" src="/images/banner-logos/scala-full-color.svg" alt="Scala by Lightbend" title="Scala by Lightbend">
						</a>
						<div class="lagom current">
							<img class="lagom-full-color-logo" src="/images/banner-logos/lagom-full-color.svg" alt="Lagom Framework by Lightbend" title="Lagom Framework by Lightbend">
							<span>From the creators of <strong>Lagom</strong>, get technology enhancements, monitoring, and expert support with Akka Platform from Lightbend.</span>
							<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Learn More [Button] - Lagom Banner" href="https://www.lightbend.com/lagom-framework-part-of-akka-platform?r=oss-banner-lagom" target="_blank">Learn More</a>
						</div>
					</div>
					<div class="title">The Lightbend Family</div>
				</div>      
			</div>
		</div>
	</div>
</div>

                    <header class="navbar">
                        <div class="row">
                            <div class="small-12 columns">
                                <button class="menu-icon hide-for-medium" type="button" data-open="offCanvasLeft" data-toggle="offCanvas"></button>
                                <a class="logo" href="/"><svg id="Lagom_Full_Color" class="svg-logo svg-logo-lagom-full-color" data-name="Lagom Full Color" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 752 192"><title>logom</title><g id="Lagom"><path d="M291.58,31.79h19.83v87.91c0,8.1,2.64,11.57,9.91,11.57a21.11,21.11,0,0,0,5.95-.66V148.3a35.63,35.63,0,0,1-9.42,1c-17.52,0-26.28-8.92-26.28-26.94V31.79Z" fill="#652b7c"/><path d="M398.34,75.75V63.69h19.83v58.17c0,7.11,1.65,9.75,6.11,9.75a41.28,41.28,0,0,0,4.13-.33v16a28.65,28.65,0,0,1-9.75,1.32c-4.79,0-8.59-.83-11.57-2.64a15.33,15.33,0,0,1-6.78-10.08C394.53,144.66,385,149,371.73,149A39.58,39.58,0,0,1,342,136.4c-7.93-8.43-11.9-18.67-11.9-31.07s4-22.64,11.9-30.9a39.58,39.58,0,0,1,29.75-12.56C385.12,61.87,395.2,67.82,398.34,75.75Zm-5.95,47.76a24.29,24.29,0,0,0,7.44-18.18,24.29,24.29,0,0,0-7.44-18.18,24.68,24.68,0,0,0-18-7.27,23.93,23.93,0,0,0-17.68,7.27c-4.63,4.79-6.94,10.91-6.94,18.18s2.31,13.39,6.94,18.18a23.93,23.93,0,0,0,17.68,7.27A24.68,24.68,0,0,0,392.39,123.51Z" fill="#652b7c"/><path d="M495.67,63.69H515.5v69.41c0,20-2.81,32.23-14,41-7.93,6.11-17.68,9.25-29.42,9.25-15.53,0-28.92-4-40.32-12.06l9.59-14.71a50.47,50.47,0,0,0,28.59,9.09q11.65,0,18.34-5c5.29-3.8,7.93-10.91,7.93-21.15v-4.13c-4,7.11-13.88,12.23-27.1,12.23a40.53,40.53,0,0,1-29.75-12.23c-7.93-8.1-11.9-18.34-11.9-30.41s4-22.31,12.06-30.57a39.23,39.23,0,0,1,29.58-12.56c13.72,0,23.8,5.78,26.61,13.88V63.69ZM489.72,123a24.19,24.19,0,0,0,7.44-18,23.82,23.82,0,0,0-7.44-17.85,24.68,24.68,0,0,0-18-7.27A23.93,23.93,0,0,0,454,87.15,24.69,24.69,0,0,0,447.09,105,25.08,25.08,0,0,0,454,123a23.79,23.79,0,0,0,17.68,7.11C478.81,130.12,484.93,127.81,489.72,123Z" fill="#652b7c"/><path d="M522.44,105.33a42.05,42.05,0,0,1,13.22-31.4c8.76-8.43,19.5-12.72,32.22-12.72s23.47,4.3,32.23,12.72a42.05,42.05,0,0,1,13.22,31.4,42.05,42.05,0,0,1-13.22,31.4c-8.76,8.43-19.5,12.72-32.23,12.72s-23.47-4.3-32.22-12.72A42.05,42.05,0,0,1,522.44,105.33ZM586.23,124a25.67,25.67,0,0,0,7.44-18.67,25,25,0,0,0-7.44-18.51,26.13,26.13,0,0,0-36.85,0,25.56,25.56,0,0,0-7.27,18.51A26.22,26.22,0,0,0,549.38,124,26.54,26.54,0,0,0,586.23,124Z" fill="#652b7c"/><path d="M620.6,147V63.69h19.67v11.9C643.74,67.49,652,62,662.58,62,674,62,681.91,66.83,686,76.58,690.84,66.83,699.76,62,712.81,62c18,0,28.42,12.72,28.42,33.38v26.28c0,6.44,1.16,8.76,5.62,8.76a14.56,14.56,0,0,0,2.81-.33v16.69a28.37,28.37,0,0,1-8.59,1c-13.05,0-19.5-7.27-19.5-21.81V98.23c0-11.4-5.29-18.51-14.54-18.51s-16,8.1-16,19.33V147H671.34V98.23c0-11.4-5.45-18.51-14.87-18.51-9.25,0-16.2,8.1-16.2,19.33V147H620.6Z" fill="#652b7c"/></g><g id="Icon"><path d="M261,84l-70,34,70,34S260.78,84.27,261,84Z" fill="#652b7c"/><polygon points="121 152 191 118 121 84 121 152" fill="#652b7c"/><path d="M191,118l70,34c-0.27,0-41.76,25-60.63,36.24a17.64,17.64,0,0,1-18,0C163.47,177,121,152,121,152Z" fill="#421540"/><path d="M200.23,47.65C219.09,58.88,261,84,261,84l-70,34L121,84c0.27,0,42.31-25.12,61.18-36.36A17.64,17.64,0,0,1,200.23,47.65Z" fill="#bf97c6"/><path d="M145,20.58l-35,17,35,17S144.89,20.72,145,20.58Z" fill="#652b7c"/><polygon points="75 54.58 110 37.58 75 20.58 75 54.58" fill="#652b7c"/><path d="M110,37.58l35,17c-0.14,0-20.88,12.5-30.31,18.12a8.82,8.82,0,0,1-9,0C96.23,67.08,75,54.58,75,54.58Z" fill="#421540"/><path d="M114.61,2.4C124,8,145,20.58,145,20.58l-35,17-35-17C75.14,20.59,96.16,8,105.59,2.4A8.82,8.82,0,0,1,114.61,2.4Z" fill="#bf97c6"/><path d="M101,91L51,115.54l50,24.53S100.84,91.21,101,91Z" fill="#652b7c"/><polygon points="1 140.07 51 115.54 1 91.02 1 140.07" fill="#652b7c"/><path d="M51,115.54l50,24.53c-0.19,0-29.83,18-43.3,26.14a12.5,12.5,0,0,1-12.89,0C31.34,158.1,1,140.07,1,140.07Z" fill="#421540"/><path d="M57.59,64.79C71.06,72.9,101,91,101,91L51,115.54,1,91C1.19,91,31.22,72.9,44.7,64.79A12.5,12.5,0,0,1,57.59,64.79Z" fill="#bf97c6"/></g></svg></a>
                                <nav class="sections show-for-medium">
                                    
<a href="/get-started.html">Try Lagom</a>
<a href="/documentation/">Documentation</a>
<a href="/faq.html">FAQ</a>
<a href="/support.html">Support</a>
<a href="/get-involved.html">Get Involved</a>
<a href="/blog/">Blog</a>

                                </nav>
                            </div>
                        </div>
                    </header>
                    <div class="fw-wrapper flush sticky-bar">
                        <div class="row">
                            <div class="small-12 columns">
                                <div class="small-menu">
                                    <button class="menu-icon" type="button" data-open="offCanvasLeft" data-toggle="offCanvas"></button>
                                    <a class="logo" href="/"><span></span></a>
                                    <nav class="sections-scroll">
                                        
<a href="/get-started.html">Try Lagom</a>
<a href="/documentation/">Documentation</a>
<a href="/faq.html">FAQ</a>
<a href="/support.html">Support</a>
<a href="/get-involved.html">Get Involved</a>
<a href="/blog/">Blog</a>

                                    </nav>
                                    <nav class="social">
                                        <a href="https://discuss.lagomframework.com"><span>Discuss Lagom</span></a>
                                        <a href="https://twitter.com/lagom"><span>Twitter</span></a>
                                        <a href="https://github.com/lagom/lagom"><span>GitHub</span></a>
                                        <a href="https://stackoverflow.com/questions/tagged/lagom"><span>Stack Overflow</span></a>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>

                     
    <header class="fw-wrapper lgm-purple page-title">
        <div class="row">
            <div class="small-12 columns">
                <h1>Message Broker API</h1>
            </div>
        </div>
    </header>

    <div class="fw-wrapper documentation-content">
        <div class="row">
            <div class="small-12 large-7 columns">
                
                    <nav class="breadcrumbs">
                        <a href="Home.html">Scala Home</a>
                        
                                    &raquo;
                            <a href="ReferenceGuide.html">Lagom reference guide</a>
                        
                                    &raquo;
                            <a href="MessageBroker.html">Decouple services with a message broker</a>
                        
                    </nav>
                

                <article>
                <h1 id="Message-Broker-API"><a class="section-marker" href="#Message-Broker-API">§</a>Message Broker API</h1>
<p>The Lagom Message Broker API provides a distributed publish-subscribe model that services can use to share data via topics. A topic is simply a channel that allows services to push and pull data. In Lagom, topics are strongly typed, hence both the subscriber and producer can know in advance what the expected data flowing through will be.</p><h2 id="Declaring-a-topic"><a class="section-marker" href="#Declaring-a-topic">§</a>Declaring a topic</h2>
<p>To publish data to a topic a service needs to declare the topic in its <a href="ServiceDescriptors.html#Service-Descriptors">service descriptor</a>.</p>
<pre class="prettyprint"><code class="language-scala">import com.lightbend.lagom.scaladsl.api.broker.Topic
import com.lightbend.lagom.scaladsl.api.Service
import com.lightbend.lagom.scaladsl.api.ServiceCall
import play.api.libs.json.Format
import play.api.libs.json.Json

object HelloService {
  val TOPIC_NAME = &quot;greetings&quot;
}
trait HelloService extends Service {

  final override def descriptor = {
    import Service._
    named(&quot;brokerdocs&quot;)
      .withCalls(
        pathCall(&quot;/api/hello/:id&quot;, hello _),
        pathCall(&quot;/api/hello/:id&quot;, useGreeting _)
      )
      .withTopics(
        topic(HelloService.TOPIC_NAME, greetingsTopic)
      )
      .withAutoAcl(true)
  }

  // The topic handle
  def greetingsTopic(): Topic[GreetingMessage]

  def hello(id: String): ServiceCall[NotUsed, String]
  def useGreeting(id: String): ServiceCall[GreetingMessage, Done]
}</code></pre>
<p>The syntax for declaring a topic is similar to the one used already to define services&rsquo; endpoints. The <a href="api/com/lightbend/lagom/scaladsl/api/Descriptor.html"><code>Descriptor.withTopics</code></a> method accepts a sequence of topic calls, each topic call can be defined via the <a href="api/com/lightbend/lagom/scaladsl/api/Service$.html"><code>topic</code></a> method on the <code>Service</code> object. The latter takes a topic name (i.e., the topic identifier), and a method reference that returns a <a href="api/com/lightbend/lagom/scaladsl/api/broker/Topic.html"><code>Topic</code></a> instance.</p>
<p>Data flowing through a topic is serialized to JSON by default. Of course, it is possible to use a different serialization format, and you can do so by providing an implicit message serializer for each topic defined in a service descriptor. This is the same approach described on <a href="ServiceDescriptors.html#Message-serialization">message serialization</a> when presenting <a href="ServiceDescriptors.html">Service Descriptors</a>. You may want to review the <a href="MessageSerializers.html">message serializers documentation</a> too.</p><h3 id="Partitioning-topics"><a class="section-marker" href="#Partitioning-topics">§</a>Partitioning topics</h3>
<p>Kafka will distribute messages for a particular topic across many partitions, so that the topic can scale. Messages sent to different partitions may be processed out of order, so if the ordering of the messages you are publishing matters, you need to ensure that the messages are partitioned in such a way that order is preserved. Typically, this means ensuring each message for a particular entity goes to the same partition.</p>
<p>Lagom allows this by allowing you to configure a partition key strategy, which extracts the partition key out of a message. Kafka will then use this key to help decide what partition to send each message to. The partition can be selected using the <a href="api/com/lightbend/lagom/scaladsl/api/broker/kafka/KafkaProperties$.html#partitionKeyStrategy[Message]:com.lightbend.lagom.scaladsl.api.Descriptor.Property[Message,com.lightbend.lagom.scaladsl.api.broker.kafka.PartitionKeyStrategy[Message]]"><code>partitionKeyStrategy</code></a> property, by passing a <a href="api/com/lightbend/lagom/scaladsl/api/broker/kafka/PartitionKeyStrategy.html"><code>PartitionKeyStrategy</code></a> to it:</p>
<pre class="prettyprint"><code class="language-scala">named(&quot;blogpostservice&quot;)
  .withTopics(
    topic(&quot;blogposts&quot;, blogPostEvents)
      .addProperty(
        KafkaProperties.partitionKeyStrategy,
        PartitionKeyStrategy[BlogPostEvent](_.postId)
      )
  )</code></pre><h2 id="Implementing-a-topic"><a class="section-marker" href="#Implementing-a-topic">§</a>Implementing a topic</h2>
<p>The primary source of messages that Lagom is designed to produce is persistent entity events. Rather than publishing events in an ad-hoc fashion in response to particular things happening, it is better to take the stream of events from your persistent entities, and adapt that to a stream of messages sent to the message broker. In this way, you can ensure at least once processing of events by both publishers and consumers, which allows you to guarantee a very strong level of consistency throughout your system.</p>
<p>Lagom&rsquo;s <a href="api/com/lightbend/lagom/scaladsl/broker/TopicProducer$.html"><code>TopicProducer</code></a> helper provides two methods for publishing a persistent entities event stream, <a href="api/com/lightbend/lagom/scaladsl/broker/TopicProducer$.html"><code>singleStreamWithOffset</code></a> for use with non sharded read side event streams, and <a href="api/com/lightbend/lagom/scaladsl/broker/TopicProducer$.html"><code>taggedStreamWithOffset</code></a> for use with sharded read side event streams. Both of these methods take a callback which takes the last offset that the topic producer published, and allows resumption of the event stream from that offset via the <a href="api/com/lightbend/lagom/scaladsl/persistence/PersistentEntityRegistry.html"><code>PersistentEntityRegistry.eventStream</code></a> method for obtaining a read-side stream. For more details on read-side streams, see <a href="ReadSide.html#Raw-Stream-of-Events">Persistent Read-Side's</a>.</p>
<p>Lagom will, in the case of the <code>singleStreamWithOffset</code> method, ensure that your topic producer only runs on one node of your cluster, or with the <code>taggedStreamWithOffset</code> method will distribute the tags evenly across the cluster to distribute the publishing load.</p>
<p>Here&rsquo;s an example of publishing a single, non sharded event stream:</p>
<pre class="prettyprint"><code class="language-scala">override def greetingsTopic(): Topic[GreetingMessage] =
  TopicProducer.singleStreamWithOffset { fromOffset =&gt;
    persistentEntityRegistry
      .eventStream(HelloEventTag.INSTANCE, fromOffset)
      .map(ev =&gt; (convertEvent(ev), ev.offset))
  }

private def convertEvent(helloEvent: EventStreamElement[HelloEvent]): GreetingMessage = {
  helloEvent.event match {
    case GreetingMessageChanged(msg) =&gt; GreetingMessage(msg)
  }
}</code></pre>
<p>Note that the read-side event stream you passed to the topic producer is &ldquo;activated&rdquo; as soon as the service is started. That means that in the previous example, all events persisted by your services will eventually be published to the connected topic. Also, you will generally want to map your domain events into some other type, so that other service won&rsquo;t be tightly coupled to another service&rsquo;s domain model events. In other words, domain model events are an implementation detail of the service, and should not be leaked.</p><h3 id="Filtering-events"><a class="section-marker" href="#Filtering-events">§</a>Filtering events</h3>
<p>You may not want all events persisted by your services to be published. If that is the case then you can filter the event stream:</p>
<pre class="prettyprint"><code class="language-scala">override def greetingsTopic(): Topic[GreetingMessage] =
  TopicProducer.singleStreamWithOffset { fromOffset =&gt;
    persistentEntityRegistry
      .eventStream(HelloEventTag.INSTANCE, fromOffset)
      .mapConcat(filterEvents)
  }

private def filterEvents(ev: EventStreamElement[HelloEvent]) = ev match {
  // Only publish greetings where the message is &quot;Hello&quot;.
  case ev @ EventStreamElement(_, GreetingMessageChanged(&quot;Hello&quot;), offset) =&gt;
    immutable.Seq((convertEvent(ev), offset))
  case _ =&gt; Nil
}</code></pre>
<p>When an event is filtered, the <code>TopicProducer</code> does not publish the event. It also does not advance the offset. If the <code>TopicProducer</code> restarts then it will resume from the last offset. If a large number of events are filtered then the last offset could be quite far behind, and so all those events will be reprocessed and filtered out again. You need to be aware that this may occur and keep the number of consecutively filtered elements relatively low and also minimize the time and resources required to perform the filtering.</p><h3 id="Offset-storage"><a class="section-marker" href="#Offset-storage">§</a>Offset storage</h3>
<p>Lagom will use your configured persistence API provider to store the offsets for your event streams. To read more about offset storage, see the <a href="ReadSideCassandra.html#Building-the-read-side-handler">Cassandra offset documentation</a>, <a href="ReadSideJDBC.html#Building-the-read-side-handler">JDBC database offset documentation</a> and <a href="ReadSideSlick.html#Building-the-read-side-handler">Slick database offset documentation</a>.</p><h2 id="Subscribe-to-a-topic"><a class="section-marker" href="#Subscribe-to-a-topic">§</a>Subscribe to a topic</h2>
<p>To subscribe to a topic, a service just needs to call <a href="api/com/lightbend/lagom/scaladsl/api/broker/Topic.html"><code>Topic.subscribe</code></a> on the topic of interest. For instance, imagine that a service wants to collect all greetings messages published by the <code>HelloService</code>. The first thing you should do is inject a <code>HelloService</code> (See the section on <a href="ServiceClients.html#Using-a-service-client">using service clients</a> for a complete explanation on using a client to another service). Then, subscribe to the greetings topic, and hook your logic to apply to each messages that published to the topic.</p>
<pre class="prettyprint"><code class="language-scala">helloService
  .greetingsTopic()
  .subscribe // &lt;-- you get back a Subscriber instance
  .atLeastOnce(
    Flow.fromFunction(doSomethingWithTheMessage)
  )</code></pre>
<p>When calling <a href="api/com/lightbend/lagom/scaladsl/api/broker/Topic.html#subscribe:com.lightbend.lagom.scaladsl.api.broker.Subscriber[Message]"><code>Topic.subscribe</code></a> you will get back a <a href="api/com/lightbend/lagom/scaladsl/api/broker/Subscriber.html"><code>Subscriber</code></a> instance. In the above code snippet we have subscribed to the <code>greetings</code> topic using at-least-once delivery semantics. That means each message published to the <code>greetings</code> topic is received at least once, but possibly more. The subscriber also offers a <a href="api/com/lightbend/lagom/scaladsl/api/broker/Subscriber.html#atMostOnceSource:akka.stream.scaladsl.Source[Message,_]"><code>atMostOnceSource</code></a> that gives you at-most-once delivery semantics. If in doubt, prefer using at-least-once delivery semantics.</p>
<p>Finally, subscribers are grouped together via <a href="api/com/lightbend/lagom/scaladsl/api/broker/Subscriber.html#withGroupId(groupId:String):com.lightbend.lagom.scaladsl.api.broker.Subscriber[Message]"><code>Subscriber.withGroupId</code></a>. A subscriber group allows many nodes in your cluster to consume a message stream while ensuring that each message is only handled once by each node in your cluster. Without subscriber groups, all of your nodes for a particular service would get every message in the stream, leading to their processing being duplicated. By default, Lagom will use a group id that has the same name as the service consuming the topic.</p><h3 id="Consuming-message-metadata"><a class="section-marker" href="#Consuming-message-metadata">§</a>Consuming message metadata</h3>
<p>Your broker implementation may provide additional metadata with messages which you can consume. This can be accessed by invoking the <a href="api/com/lightbend/lagom/scaladsl/api/broker/Subscriber.html#withMetadata:com.lightbend.lagom.scaladsl.api.broker.Subscriber[com.lightbend.lagom.scaladsl.api.broker.Message[Payload]]"><code>Subscriber.withMetadata</code></a> method, which returns a subscriber that wraps the messages in a <a href="api/com/lightbend/lagom/scaladsl/api/broker/Message.html"><code>Message</code></a>.</p>
<pre class="prettyprint"><code class="language-scala">import com.lightbend.lagom.scaladsl.api.broker.Message
import com.lightbend.lagom.scaladsl.broker.kafka.KafkaMetadataKeys

helloService
  .greetingsTopic()
  .subscribe
  .withMetadata
  .atLeastOnce(
    Flow[Message[GreetingMessage]].map { msg =&gt;
      val greetingMessage = msg.payload
      val messageKey      = msg.messageKeyAsString
      val kafkaHeaders    = msg.get(KafkaMetadataKeys.Headers)
      println(s&quot;Message: $greetingMessage Key: $messageKey Headers: $kafkaHeaders&quot;)
      Done
    }
  )</code></pre>
<p>The <a href="api/com/lightbend/lagom/scaladsl/api/broker/Message.html#messageKeyAsString:String"><code>messageKeyAsString</code></a> method is provided as a convenience for accessing the message key. Other properties can be accessed using the <a href="api/com/lightbend/lagom/scaladsl/api/broker/Message.html#get(com.lightbend.lagom.scaladsl.api.broker.MetadataKey[Metadata]):Metadata"><code>get</code></a> method. A full list of the metadata keys available for Kafka can be found <a href="api/com/lightbend/lagom/scaladsl/broker/kafka/KafkaMetadataKeys$.html">here</a>.</p><h3 id="Skipping-messages"><a class="section-marker" href="#Skipping-messages">§</a>Skipping messages</h3>
<p>You may only want to apply your logic to a subset of the messages that the topic publishes and skip the others. The <code>Flow</code> that is passed to <a href="api/com/lightbend/lagom/scaladsl/api/broker/Subscriber.html#atLeastOnce(flow:akka.stream.scaladsl.Flow[Payload,akka.Done,_]):scala.concurrent.Future[akka.Done]"><code>Subscriber.atLeastOnce</code></a> must emit exactly one <code>Done</code> element for each element that it receives. It must also emit them in the same order that the elements were received. This means that you must not use methods such as <code>filter</code> or <code>collect</code> on the <code>Flow</code> which would drop elements.</p>
<p>The easiest way to achieve this is to use a total function which returns <code>Done</code> for the elements that should be skipped. For example:</p>
<pre class="prettyprint"><code class="language-scala">helloService
  .greetingsTopic()
  .subscribe
  .atLeastOnce(
    Flow[GreetingMessage].map {
      case msg @ GreetingMessage(&quot;Kia ora&quot;) =&gt; doSomethingWithTheMessage(msg)
      case _                                =&gt; Done // Skip all messages where the message is not &quot;Kia ora&quot;.
    }
  )</code></pre><h2 id="Polymorphic-event-streams"><a class="section-marker" href="#Polymorphic-event-streams">§</a>Polymorphic event streams</h2>
<p>Typically you will want to publish more than one type of event to a particular topic. This can be done by creating an interface that each event implements. In order to successfully serialize these events to and from JSON, you will have to include some extra information on your JSON representation of the data.</p>
<p>For example, consider a situation where you have a blog post created event and a blog post published event. Here&rsquo;s what your event structure might look like:</p>
<pre class="prettyprint"><code class="language-scala">sealed trait BlogPostEvent {
  def postId: String
}

case class BlogPostCreated(postId: String, title: String) extends BlogPostEvent

case class BlogPostPublished(postId: String) extends BlogPostEvent</code></pre>
<p>And that&rsquo;s how your Play JSON formatters could look like:</p>
<pre class="prettyprint"><code class="language-scala">case object BlogPostCreated {
  implicit val blogPostCreatedFormat: Format[BlogPostCreated] = Json.format
}

case object BlogPostPublished {
  implicit val blogPostPublishedFormat: Format[BlogPostPublished] = Json.format
}</code></pre>
<p>You will have to implement a custom Message Serializer that adds extra information on each JSON message so that you know what deserializer to use on the other end. The resulting JSON for the <code>BlogPostCreated</code> event will look like this:</p>
<pre class="prettyprint"><code class="language-json">{
 &quot;postId&quot;: &quot;23&quot;,
 &quot;title&quot;: &quot;new post&quot;,
 &quot;event_type&quot;: &quot;postCreated&quot;
}
</code></pre>
<p>While the JSON for the <code>BlogPostPublished</code> event will look like this:</p>
<pre class="prettyprint"><code class="language-json">{
 &quot;postId&quot;: &quot;23&quot;,
 &quot;event_type&quot;: &quot;postPublished&quot;
}
</code></pre>
<p>You can do that using <a href="https://www.playframework.com/documentation/2.6.x/ScalaJsonTransformers#Case-5:-Put-a-given-value-in-a-new-branch">Play JSON transformers</a>:</p>
<pre class="prettyprint"><code class="language-scala">object BlogPostEvent {
  implicit val reads: Reads[BlogPostEvent] = {
    (__ \ &quot;event_type&quot;).read[String].flatMap {
      case &quot;postCreated&quot;   =&gt; implicitly[Reads[BlogPostCreated]].map(identity)
      case &quot;postPublished&quot; =&gt; implicitly[Reads[BlogPostPublished]].map(identity)
      case other           =&gt; Reads(_ =&gt; JsError(s&quot;Unknown event type $other&quot;))
    }
  }
  implicit val writes: Writes[BlogPostEvent] = Writes { event =&gt;
    val (jsValue, eventType) = event match {
      case m: BlogPostCreated   =&gt; (Json.toJson(m)(BlogPostCreated.blogPostCreatedFormat), &quot;postCreated&quot;)
      case m: BlogPostPublished =&gt; (Json.toJson(m)(BlogPostPublished.blogPostPublishedFormat), &quot;postPublished&quot;)
    }
    jsValue.transform(__.json.update((__ \ &#39;event_type).json.put(JsString(eventType)))).get
  }
}
</code></pre>
<p>This approach has an added maintenance cost. Fortunately there are libraries that expand Play JSON features and provide support for algebraic data type serialization. For example: <a href="https://github.com/julienrf/play-json-derived-codecs">Play JSON Derived Codecs</a>.</p>
                </article>

                
                    
                        
                            <nav class="next-link">
                                <a href="KafkaClient.html"><strong>Next: </strong>
                                    Lagom Kafka Client</a>
                            </nav>
                        
                    
                

                
                    <p class="edit-source">Found an error in this documentation? The source code for this page can be found
                        <a href="https://github.com/lagom/lagom/edit/1.4.x/docs/manual/scala/guide/broker/MessageBrokerApi.md">here</a>. Please feel free to edit and contribute a pull request. </p>
                
            </div>
            <aside class="small-12 large-4 columns">
                <nav class="side-menu">

                    <input type="search" id="cross-docs-search" placeholder="Search..." />

                    <label for="docs-version">Version:</label>
                    <select id="docs-version">
                    
                        <option value="/documentation/1.3.x/scala/MessageBrokerApi.html" >1.3.x</option>
                    
                        <option value="/documentation/1.4.x/scala/MessageBrokerApi.html" 
                            selected="selected">1.4.x</option>
                    
                        <option value="/documentation/1.5.x/scala/MessageBrokerApi.html" >1.5.x</option>
                    
                        <option value="/documentation/1.6.x/scala/MessageBrokerApi.html" >1.6.x</option>
                    
                        <option value="/documentation/current/scala/MessageBrokerApi.html" >current</option>
                    
                        <option value="/documentation/latest/scala/MessageBrokerApi.html" >latest</option>
                    
                    </select>

                    <a href="/documentation/1.4.x/scala/api/com/lightbend/lagom/scaladsl/index.html" class="api-docs">
                        API Documentation</a>

                    
                        <h3>Decouple services with a message broker</h3>
                        <ul>
                        
                            
                                <li><a href="MessageBroker.html">Message Broker Support</a></li>
                            
                        
                            
                                <li class="current-page"><a href="MessageBrokerApi.html">Message Broker API</a></li>
                            
                        
                            
                                <li><a href="KafkaClient.html">Lagom Kafka Client</a></li>
                            
                        
                            
                                <li><a href="MessageBrokerTesting.html">Message Broker Testing</a></li>
                            
                        
                        </ul>
                    
                        <h3>Lagom reference guide</h3>
                        <ul>
                        
                            
                                <li><a href="ReferenceGuide.html">Reference Guide</a></li>
                            
                        
                            
                                <li><a href="LagomBuild.html">Configuring builds and the development environment</a></li>
                            
                        
                            
                                <li><a href="DevEnvironment.html">Running Lagom in development</a></li>
                            
                        
                            
                                <li><a href="ServiceDescriptors.html">Writing Lagom services</a></li>
                            
                        
                            
                                <li><a href="PersistentEntity.html">Writing persistent and clustered services</a></li>
                            
                        
                            
                                <li class="current-page"><a href="MessageBroker.html">Decouple services with a message broker</a></li>
                            
                        
                            
                                <li><a href="ProductionOverview.html">Running Lagom in production</a></li>
                            
                        
                            
                                <li><a href="Logging.html">Logging</a></li>
                            
                        
                            
                                <li><a href="Akka.html">Advanced topics</a></li>
                            
                        
                        </ul>
                    
                        <h3>Scala Home</h3>
                        <ul>
                        
                            
                                <li><a href="Home.html">Home</a></li>
                            
                        
                            
                                <li><a href="WhatIsLagom.html">Welcome to Lagom</a></li>
                            
                        
                            
                                <li><a href="Installation.html">Getting started with Lagom</a></li>
                            
                        
                            
                                <li><a href="CoreConcepts.html">Lagom core concepts</a></li>
                            
                        
                            
                                <li class="current-page"><a href="ReferenceGuide.html">Lagom reference guide</a></li>
                            
                        
                            
                                <li><a href="Migration14.html">Lagom releases</a></li>
                            
                        
                        </ul>
                    
                </nav>
            </aside>
        </div>
    </div>


                    <footer>
                        <section class="fw-wrapper lb-grey-dkr support">
                            <div class="row">
                                <div class="small-12 medium-6 columns">
                                    <svg class="svg-icon svg-icon-chat" version="1.1" id="Chat" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" style="enable-background:new 0 0 20 20;" xml:space="preserve">
<path fill="#ffffff" d="M5.8,12.2V6H2C0.9,6,0,6.9,0,8v6c0,1.1,0.9,2,2,2h1v3l3-3h5c1.1,0,2-0.9,2-2v-1.82c-0.064,0.014-0.132,0.021-0.2,0.021h-7
	V12.2z M18,1H9C7.9,1,7,1.9,7,3v8h7l3,3v-3h1c1.1,0,2-0.899,2-2V3C20,1.9,19.1,1,18,1z"/>
</svg>

                                    <h3>Community support</h3>
                                    <ul>
                                        <li><a href="https://discuss.lagomframework.com">Discuss Lagom</a></li>
                                        <li><a href="https://stackoverflow.com/questions/tagged/lagom">Stack Overflow</a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 columns">
                                    <svg class="svg-icon svg-icon-lb-icon-reverse" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 302 262">
    <title>lightbend-icon</title>
    <path  fill="#ffffff" d="M1,195v56a10,10,0,0,0,10,10H291a10,10,0,0,0,10-10V195a557.85,557.85,0,0,1-150,20A557.85,557.85,0,0,1,1,195Z" />
    <path  fill="#ffffff" d="M291,1H11A10,10,0,0,0,1,11V176a539.94,539.94,0,0,0,150,21,539.94,539.94,0,0,0,150-21V11A10,10,0,0,0,291,1Z" />
</svg>

                                    <h3>Professional support</h3>
                                    <ul>
                                        <li><a href="https://www.lightbend.com/services/expert-support">Lightbend Subscription</a></li>
                                        <li><a href="https://www.lightbend.com/services/training">Training</a></li>
                                        <li><a href="https://www.lightbend.com/services/consulting">Consulting</a></li>
                                    </ul>
                                </div>
                            </div>
                        </section>

                        <section class="fw-wrapper lb-grey links">
                            <div class="row">
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Lagom</h3>
                                    <ul class="no-bullet">
                                        <li><a href="/get-started.html">Try Lagom</a></li>
                                        <li><a href="/blog">Blog</a></li>
                                        <li><a href="/documentation/">Documentation</a></li>
                                        <li><a href="/faq">FAQ</a></li>
                                        <li><a href="/support">Support</a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Community links</h3>
                                    <ul>
                                        <li><a href="https://www.eventbrite.com/directory/?q=lagom&amp;loc=Worldwide">Events <em>via Eventbrite</em></a></li>
                                        <li><a href="http://www.indeed.com/jobs?q=%22lagom%22&amp;l=">Jobs <em>via Indeed</em></a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Code &amp; contribution</h3>
                                    <ul>
                                        <li><a href="https://github.com/lagom/lagom/issues">Bug tracker <em>GitHub</em></a></li>
                                        <li><a href="/get-involved.html">Get involved</a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Social networks</h3>
                                    <ul>
                                        <li><a href="https://twitter.com/lagom"><span>Twitter</span></a></li>
                                    </ul>
                                </div>
                            </div>
                        </section>

                        <section class="fw-wrapper lgm-purple-dkr credits">
                            <div class="row">
                                <div class="small-12 medium-3 columns">
                                    <a href="/" class="logo"><img src="/images/logos/lagom-reverse.svg"></a>
                                </div>
                                <div class="small-12 medium-3 columns">
                                    <a href="https://www.lightbend.com" class="partner"><img src="/images/logos/lightbend-reverse.svg"></a>
                                </div>
                                <div class="small-12 medium-6 columns">
                                    <p>Lagom is released under the Apache 2 License</p>
                                </div>
                            </div>
                            <div class="row lb-legal">
                                <div class="small-12 columns">
                                    <p>
                                        &copy; Lightbend 2018 | 
                                        <a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> | 
                                        <a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> | 
                                        <a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> | 
                                        <a href="/cookie.html">Cookie Listing</a> | 
                                        <a class="optanon-toggle-display">Cookie Settings</a>
                                    </p>
                                </div>
                            </div>
                        </section>

                    </footer>

                </div>
            </div>
        </div>
    </body>
    <script src="/fc8a16ee954e5d690ad63c500f4b4e32df567146-all-scripts-concat.js"></script>
    
     
    <script type="text/javascript" src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
        <!-- Cross-site search. This is using Algolia's autocomplete.js  -->
    <script>
            var clientLagom = algoliasearch('BH4D9OD16A', '77ef1e29e6bddfca861f7a42cc51725e');
            var lagomIndex = clientLagom.initIndex('lagomframework');

            var displayValue = function (suggestion, level) {
                if (level === 0)
                    return suggestion._highlightResult.hierarchy.lvl0.value;
                if (suggestion._highlightResult.hierarchy['lvl' + level] !== undefined) {
                    return suggestion._highlightResult.hierarchy['lvl' + level].value ;
                } else {
                    return displayValue(suggestion, level - 1) ;
                }
            };
            var displaySnippet = function (suggestion) {
                if (typeof suggestion._snippetResult !== 'undefined') {
                    return '<div class="algolia-docsearch-suggestion--text">' + suggestion._snippetResult.content.value + '</div>'
                } else {
                    return ''
                }
            }

            var wrap = function (content, wrapper) {
                if (typeof wrapper !== 'undefined') {
                    return '<span class=' + wrapper + '>' + content + '</span>';
                } else {
                    return content;
                }
            }

            var buildIndexSettings = function (_indexObj, _hitsPerPage, _faceFilters, title, useFooter, wrapper) {
                var _header = wrap('<span class="algolia-docsearch-suggestion algolia-docsearch-suggestion__main algolia-docsearch-suggestion__secondary algolia-docsearch-suggestion--category-header ">' + title + '</span>', wrapper);
                var _templates = {
                    header: _header,
                    suggestion: function (suggestion) {
                        var suggestionHtml = '<div class="algolia-docsearch-suggestion algolia-docsearch-suggestion__secondary" style="white-space: normal;">' +
                                '<div class="algolia-docsearch-suggestion--wrapper">' +
                                '<div class="algolia-docsearch-suggestion--subcategory-column ">' +
                                '<span class="algolia-docsearch-suggestion--subcategory-column-text">' + displayValue(suggestion, 0) + '</span>' +
                                '</div>' +
                                '<div class="algolia-docsearch-suggestion--content">' +
                                '<div class="algolia-docsearch-suggestion--subcategory-inline ">' + displayValue(suggestion, 1) + '</div>' +
                                '<div class="algolia-docsearch-suggestion--title algolia-docsearch-suggestion--duplicate-content">' + displayValue(suggestion, 2) + '</div>' +
                                displaySnippet(suggestion) +
                                '</div>' +
                                '</div>' +
                                '</div>';
                        return wrap(suggestionHtml, wrapper)
                    }
                };
                if (useFooter) {
                    _templates['footer'] = '<div class="algolia-docsearch-footer"><a class="algolia-docsearch-footer--logo" href="https://www.algolia.com/docsearch">Algolia</a></div>';
                }

                return {
                    source: autocomplete.sources.hits(
                            _indexObj,
                            {hitsPerPage: _hitsPerPage, facetFilters: _faceFilters}
                    )
                    ,
                    templates: _templates
                };

            };

            var lagomFacetFilters = ['version:current'];

            var useScalaFacetFilter = window.location.href.split('/').includes("scala");
            if (useScalaFacetFilter) {
                lagomFacetFilters.push('language:scala');
            } else {
                lagomFacetFilters.push('language:java');
            }


            autocomplete('#cross-docs-search',
                    {hint: false},
                    [
                        buildIndexSettings(lagomIndex, 10, lagomFacetFilters, "Lagom Documentation", false)
                    ]
            ).on('autocomplete:selected', function (event, suggestion, dataset) {
                location.href = suggestion.url;
            });
    </script>


    

    <script type="text/plain" class="optanon-category-2">
  		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  		ga('create', 'UA-84991267-1', 'auto');
  		ga('send', 'pageview');

        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-MT586J3');
	</script>
</html>

