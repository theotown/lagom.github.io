
<!DOCTYPE html>
<html class="noios">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Lagom - Persistent Read-Side</title>
        <meta name="description" content="Lagom">
        
            <link rel="canonical" href="https://www.lagomframework.com/documentation/1.6.x/java/ReadSide.html"/>
        
        <meta name="viewport" content="width=device-width,maximum-scale=1"/>
        <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700" rel="stylesheet" type="text/css"/>
        <link rel="stylesheet" href="/8be04369559d94442613cb3d5ea4e194d42e8a40-all-styles-concat.css" type="text/css">
        <!-- OneTrust Cookies Consent Notice (Production Standard, lagomframework.com, en-GB) start -->
        <script src="https://optanon.blob.core.windows.net/consent/1ee3f0d6-9ed5-4b9e-bed7-ce6faaeaca5d.js" type="text/javascript" charset="UTF-8"></script>
        <script type="text/javascript">
            function OptanonWrapper() { 
                (function($) {
                    $(function() {
                        //find each YT embed and only load if cookies have been approved
                        $( ".yt-widget" ).each(function( index ) {
                            var ytID = $(this).attr("id").slice(3);
                            Optanon.InsertHtml('<iframe id="player" class="youtube-embed-player" src="//www.youtube.com/embed/'+ytID+'?rel=0&amp;autohide=1&amp;modestbranding=0&amp;showinfo=1" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>', 'yt-'+ytID, null, {deleteSelectorContent: true}, 4);
                        });
                    });
                })(jQuery);
            }
        </script>
        <!-- OneTrust Cookies Consent Notice (Production Standard, lagomframework.com, en-GB) end -->
         
    <link rel="stylesheet" href="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" />
    

    </head>
    <body>
        <div class="off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>
                <div class="off-canvas position-left" id="offCanvasLeft" data-off-canvas >
                    <nav>
                        <button class="close-button" aria-label="Close menu" type="button" data-close>
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <a href="/get-started.html">Try Lagom</a>
                        
<h3>Documentation</h3>
<ul>
    <li><a href="/documentation">By release</a></li>
    <li><a href="/faq.html">FAQ</a></li>
    <li><a href="/blog">Team Blog</a></li>
</ul>
<h3>Find Help</h3>
<ul>
    <li><a href="https://gitter.im/lagom/lagom">Gitter channel</a></li>
    <li><a href="https://stackoverflow.com/questions/tagged/lagom">Stack overflow</a></li>
    <li><a href="/support.html">Support</a></li>
</ul>
<h3>Contribute</h3>
<ul>
    <li><a href="/get-involved.html">Get involved</a></li>
    <li><a href="https://www.lightbend.com/conduct">Code of conduct</a></li>
    <li><a href="/community-process.html">Community process</a></li>
    <li><a href="/contributing.html">Contributor guidelines</a></li>
</ul>
<!-- <h3>Programs</h3> Commented out Oct 2017 because the team is not participating in this round of the program.
<ul>
    <li><a href="/outreachy/round14.html">Outreachy</a></li>
</ul> -->

                    </nav>
                </div>
                <div class="off-canvas-content" data-off-canvas-content>

                    
<div id="lightbend-banner" class="lightbend-banner lagom full-width" data-category="OSS Lightbend Banner Impression" data-label="Lagom Banner Impression">
	<div class="wrapper">
		<div class="brand">
			<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lightbend Logo - Lagom Banner" href="https://www.lightbend.com?r=oss-banner-lagom" target="_blank">
				<img class="lightbend-logo" src="/images/banner-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
			</a>
		</div>
		<div class="nav">
			<a class="banner-btn oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Enhance your Lagom services with Akka Platform [Button] - Lagom Banner" href="https://www.lightbend.com/lagom-framework-part-of-akka-platform?r=oss-banner-lagom" target="_blank">
				<span>Enhance your Lagom services with</span>
				<img class="akka-platform-reverse-logo" src="/images/banner-logos/akka-platform-reverse.svg" alt="Akka Platform" title="Akka Platform">
			</a>
			<div class="drop-down">
				<svg class="svg-chevon-circle-down" version="1.1" id="Chevron_circled_down" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
					<path fill="#ffffff" d="M12.505,8.698L10,11L7.494,8.698c-0.198-0.196-0.518-0.196-0.718,0c-0.197,0.196-0.197,0.515,0,0.71l2.864,2.807
					c0.199,0.196,0.52,0.196,0.717,0l2.864-2.807c0.199-0.195,0.198-0.514,0-0.71C13.024,8.502,12.704,8.502,12.505,8.698z M10,0.4
					c-5.302,0-9.6,4.298-9.6,9.6c0,5.303,4.298,9.6,9.6,9.6s9.6-4.297,9.6-9.6C19.6,4.698,15.302,0.4,10,0.4z M10,18.354
					c-4.615,0-8.354-3.74-8.354-8.354c0-4.614,3.739-8.354,8.354-8.354c4.613,0,8.354,3.74,8.354,8.354
					C18.354,14.614,14.613,18.354,10,18.354z" />
				</svg>
				<div class="drop-down-content">
					<div class="lightbend-family">
						<a href="https://akka.io" class="akka oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Akka - Logo Tag Line - Lagom Banner">
							<img class="akka-full-color-logo" src="/images/banner-logos/akka-full-color.svg" alt="Akka by Lightbend" title="Akka by Lightbend">
						</a>
						<a href="https://cloudflow.io" class="cloudflow oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudflow - Logo Tag Line - Lagom Banner">
							<img class="cloudflow-full-color-logo" src="/images/banner-logos/cloudflow-full-color.svg" alt="Cloudflow by Lightbend" title="Cloudflow by Lightbend">
						</a>
						<a href="https://cloudstate.io" class="cloudstate oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudstate - Logo Tag Line - Lagom Banner">
							<img class="cloudstate-full-color-logo" src="/images/banner-logos/cloudstate-full-color.svg" alt="Cloudstate by Lightbend" title="Cloudstate by Lightbend">
						</a>
						<a href="https://www.playframework.com" class="play oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Play - Logo Tag Line - Lagom Banner">
							<img class="play-full-color-logo" src="/images/banner-logos/play-full-color.svg" alt="Play Framework by Lightbend" title="Play Framework by Lightbend">
						</a>
						<a href="https://www.scala-lang.org" class="scala oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Scala - Logo Tag Line - Lagom Banner">
							<img class="scala-full-color-logo" src="/images/banner-logos/scala-full-color.svg" alt="Scala by Lightbend" title="Scala by Lightbend">
						</a>
						<div class="lagom current">
							<img class="lagom-full-color-logo" src="/images/banner-logos/lagom-full-color.svg" alt="Lagom Framework by Lightbend" title="Lagom Framework by Lightbend">
							<span>From the creators of <strong>Lagom</strong>, get technology enhancements, monitoring, and expert support with Akka Platform from Lightbend.</span>
							<a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Learn More [Button] - Lagom Banner" href="https://www.lightbend.com/lagom-framework-part-of-akka-platform?r=oss-banner-lagom" target="_blank">Learn More</a>
						</div>
					</div>
					<div class="title">The Lightbend Family</div>
				</div>      
			</div>
		</div>
	</div>
</div>

                    <header class="navbar">
                        <div class="row">
                            <div class="small-12 columns">
                                <button class="menu-icon hide-for-medium" type="button" data-open="offCanvasLeft" data-toggle="offCanvas"></button>
                                <a class="logo" href="/"><svg id="Lagom_Full_Color" class="svg-logo svg-logo-lagom-full-color" data-name="Lagom Full Color" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 752 192"><title>logom</title><g id="Lagom"><path d="M291.58,31.79h19.83v87.91c0,8.1,2.64,11.57,9.91,11.57a21.11,21.11,0,0,0,5.95-.66V148.3a35.63,35.63,0,0,1-9.42,1c-17.52,0-26.28-8.92-26.28-26.94V31.79Z" fill="#652b7c"/><path d="M398.34,75.75V63.69h19.83v58.17c0,7.11,1.65,9.75,6.11,9.75a41.28,41.28,0,0,0,4.13-.33v16a28.65,28.65,0,0,1-9.75,1.32c-4.79,0-8.59-.83-11.57-2.64a15.33,15.33,0,0,1-6.78-10.08C394.53,144.66,385,149,371.73,149A39.58,39.58,0,0,1,342,136.4c-7.93-8.43-11.9-18.67-11.9-31.07s4-22.64,11.9-30.9a39.58,39.58,0,0,1,29.75-12.56C385.12,61.87,395.2,67.82,398.34,75.75Zm-5.95,47.76a24.29,24.29,0,0,0,7.44-18.18,24.29,24.29,0,0,0-7.44-18.18,24.68,24.68,0,0,0-18-7.27,23.93,23.93,0,0,0-17.68,7.27c-4.63,4.79-6.94,10.91-6.94,18.18s2.31,13.39,6.94,18.18a23.93,23.93,0,0,0,17.68,7.27A24.68,24.68,0,0,0,392.39,123.51Z" fill="#652b7c"/><path d="M495.67,63.69H515.5v69.41c0,20-2.81,32.23-14,41-7.93,6.11-17.68,9.25-29.42,9.25-15.53,0-28.92-4-40.32-12.06l9.59-14.71a50.47,50.47,0,0,0,28.59,9.09q11.65,0,18.34-5c5.29-3.8,7.93-10.91,7.93-21.15v-4.13c-4,7.11-13.88,12.23-27.1,12.23a40.53,40.53,0,0,1-29.75-12.23c-7.93-8.1-11.9-18.34-11.9-30.41s4-22.31,12.06-30.57a39.23,39.23,0,0,1,29.58-12.56c13.72,0,23.8,5.78,26.61,13.88V63.69ZM489.72,123a24.19,24.19,0,0,0,7.44-18,23.82,23.82,0,0,0-7.44-17.85,24.68,24.68,0,0,0-18-7.27A23.93,23.93,0,0,0,454,87.15,24.69,24.69,0,0,0,447.09,105,25.08,25.08,0,0,0,454,123a23.79,23.79,0,0,0,17.68,7.11C478.81,130.12,484.93,127.81,489.72,123Z" fill="#652b7c"/><path d="M522.44,105.33a42.05,42.05,0,0,1,13.22-31.4c8.76-8.43,19.5-12.72,32.22-12.72s23.47,4.3,32.23,12.72a42.05,42.05,0,0,1,13.22,31.4,42.05,42.05,0,0,1-13.22,31.4c-8.76,8.43-19.5,12.72-32.23,12.72s-23.47-4.3-32.22-12.72A42.05,42.05,0,0,1,522.44,105.33ZM586.23,124a25.67,25.67,0,0,0,7.44-18.67,25,25,0,0,0-7.44-18.51,26.13,26.13,0,0,0-36.85,0,25.56,25.56,0,0,0-7.27,18.51A26.22,26.22,0,0,0,549.38,124,26.54,26.54,0,0,0,586.23,124Z" fill="#652b7c"/><path d="M620.6,147V63.69h19.67v11.9C643.74,67.49,652,62,662.58,62,674,62,681.91,66.83,686,76.58,690.84,66.83,699.76,62,712.81,62c18,0,28.42,12.72,28.42,33.38v26.28c0,6.44,1.16,8.76,5.62,8.76a14.56,14.56,0,0,0,2.81-.33v16.69a28.37,28.37,0,0,1-8.59,1c-13.05,0-19.5-7.27-19.5-21.81V98.23c0-11.4-5.29-18.51-14.54-18.51s-16,8.1-16,19.33V147H671.34V98.23c0-11.4-5.45-18.51-14.87-18.51-9.25,0-16.2,8.1-16.2,19.33V147H620.6Z" fill="#652b7c"/></g><g id="Icon"><path d="M261,84l-70,34,70,34S260.78,84.27,261,84Z" fill="#652b7c"/><polygon points="121 152 191 118 121 84 121 152" fill="#652b7c"/><path d="M191,118l70,34c-0.27,0-41.76,25-60.63,36.24a17.64,17.64,0,0,1-18,0C163.47,177,121,152,121,152Z" fill="#421540"/><path d="M200.23,47.65C219.09,58.88,261,84,261,84l-70,34L121,84c0.27,0,42.31-25.12,61.18-36.36A17.64,17.64,0,0,1,200.23,47.65Z" fill="#bf97c6"/><path d="M145,20.58l-35,17,35,17S144.89,20.72,145,20.58Z" fill="#652b7c"/><polygon points="75 54.58 110 37.58 75 20.58 75 54.58" fill="#652b7c"/><path d="M110,37.58l35,17c-0.14,0-20.88,12.5-30.31,18.12a8.82,8.82,0,0,1-9,0C96.23,67.08,75,54.58,75,54.58Z" fill="#421540"/><path d="M114.61,2.4C124,8,145,20.58,145,20.58l-35,17-35-17C75.14,20.59,96.16,8,105.59,2.4A8.82,8.82,0,0,1,114.61,2.4Z" fill="#bf97c6"/><path d="M101,91L51,115.54l50,24.53S100.84,91.21,101,91Z" fill="#652b7c"/><polygon points="1 140.07 51 115.54 1 91.02 1 140.07" fill="#652b7c"/><path d="M51,115.54l50,24.53c-0.19,0-29.83,18-43.3,26.14a12.5,12.5,0,0,1-12.89,0C31.34,158.1,1,140.07,1,140.07Z" fill="#421540"/><path d="M57.59,64.79C71.06,72.9,101,91,101,91L51,115.54,1,91C1.19,91,31.22,72.9,44.7,64.79A12.5,12.5,0,0,1,57.59,64.79Z" fill="#bf97c6"/></g></svg></a>
                                <nav class="sections show-for-medium">
                                    
<a href="/get-started.html">Try Lagom</a>
<a href="/documentation/">Documentation</a>
<a href="/faq.html">FAQ</a>
<a href="/support.html">Support</a>
<a href="/get-involved.html">Get Involved</a>
<a href="/blog/">Blog</a>

                                </nav>
                            </div>
                        </div>
                    </header>
                    <div class="fw-wrapper flush sticky-bar">
                        <div class="row">
                            <div class="small-12 columns">
                                <div class="small-menu">
                                    <button class="menu-icon" type="button" data-open="offCanvasLeft" data-toggle="offCanvas"></button>
                                    <a class="logo" href="/"><span></span></a>
                                    <nav class="sections-scroll">
                                        
<a href="/get-started.html">Try Lagom</a>
<a href="/documentation/">Documentation</a>
<a href="/faq.html">FAQ</a>
<a href="/support.html">Support</a>
<a href="/get-involved.html">Get Involved</a>
<a href="/blog/">Blog</a>

                                    </nav>
                                    <nav class="social">
                                        <a href="https://discuss.lagomframework.com"><span>Discuss Lagom</span></a>
                                        <a href="https://twitter.com/lagom"><span>Twitter</span></a>
                                        <a href="https://github.com/lagom/lagom"><span>GitHub</span></a>
                                        <a href="https://stackoverflow.com/questions/tagged/lagom"><span>Stack Overflow</span></a>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>

                     
    <header class="fw-wrapper lgm-purple page-title">
        <div class="row">
            <div class="small-12 columns">
                <h1>Persistent Read-Side</h1>
            </div>
        </div>
    </header>

    <div class="fw-wrapper documentation-content">
        <div class="row">
            <div class="small-12 large-7 columns">
                
                    <nav class="breadcrumbs">
                        <a href="Home.html">Java Home</a>
                        
                                    &raquo;
                            <a href="ReferenceGuide.html">Lagom reference guide</a>
                        
                                    &raquo;
                            <a href="UsingAkkaPersistenceTyped.html">Writing persistent and clustered services</a>
                        
                    </nav>
                

                <article>
                <h1 id="Persistent-Read-Side"><a class="section-marker" href="#Persistent-Read-Side">§</a>Persistent Read-Side</h1>
<p><a href="ES_CQRS.html">Event Sourcing and CQRS</a> is a recommended introduction to this section.</p>
<p><a href="PersistentEntity.html">Persistent Entities</a> are used for holding the state of individual entities, but they cannot be used for serving queries that span more than one entity. You need to know the identifier of the entity to be able to interact with it. Therefore you need to create another view of the data that is tailored to the queries that the service provides. Lagom has support for populating this read-side view of the data and also for building queries of the read-side.</p>
<p>This separation of the write-side and the read-side of the persistent data is often referred to as the <a href="https://msdn.microsoft.com/en-us/library/jj591573.aspx">CQRS</a> (Command Query Responsibility Segregation) pattern. The <a href="https://msdn.microsoft.com/en-us/library/jj554200.aspx">CQRS Journey</a> is a great resource for learning more about CQRS.</p><h2 id="Read-side-design"><a class="section-marker" href="#Read-side-design">§</a>Read-side design</h2>
<p>In Lagom, the read-side can be implemented using any datastore, using any library that runs on the JVM to populate and query it. Lagom does provide some helpers for using Cassandra and relational databases, but they are optional, they don&rsquo;t need to be used.</p>
<p>If you&rsquo;re familiar with a more traditional approach to persistence that uses tables with rows and columns, then implementing the read-side may be a little more familiar than implementing the persistent entities. There is one primary rule though, the read-side should only be updated in response to receiving events from persistent entities.</p>
<p>To handle these events, you need to provide a <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/ReadSideProcessor.html"><code>ReadSideProcessor</code></a>. A read-side processor is responsible not just for handling the events produced by the persistent entity, it&rsquo;s also responsible for tracking which events it has handled. This is done using offsets.</p>
<p>Each event produced by a persistent entity has an offset. When a read-side processor first starts, it needs to load the offset of the last event that it processed. After processing an event, it should store the offset of the event it just processed. If the storing of offsets is done atomically with any updates produced by the events, then event processing will happen exactly once for each event, otherwise it will happen at least once.</p>
<p>That said, if you use Lagom&rsquo;s built in Cassandra or relational database read-side support, then offset tracking is done automatically for you, and you only need to worry about handling the events themselves. The rest of this page will be about implementing a read-side using Lagom&rsquo;s generic read-side processor support. If you&rsquo;re using Cassandra or relational database for your read-side, you should read the remainder of this page to understand how read-sides work, but then also read the following documentation on Lagom&rsquo;s specific support in order to take advantage of Lagom&rsquo;s built in offset handling and other features for those databases:</p>
<ul>
  <li><a href="ReadSideCassandra.html">Cassandra read-side support</a></li>
  <li><a href="ReadSideRDBMS.html">Relational database read-side support</a></li>
</ul><h2 id="Query-the-Read-Side-Database"><a class="section-marker" href="#Query-the-Read-Side-Database">§</a>Query the Read-Side Database</h2>
<p>How you query the read-side database depends on your database, but there are two things to be aware of:</p>
<ul>
  <li>Ensure that any connection pools are started once, and then shut down when Lagom shuts down. Lagom is built on Play, and uses Play&rsquo;s lifecycle support to register callbacks to execute on shutdown. For information on how to hook into this, see the <a href="https://playframework.com/documentation/2.7.x/JavaDependencyInjection#Stopping/cleaning-up">Play documentation</a>.</li>
  <li>Ensure that any blocking actions are done in an appropriate execution context. Lagom assumes that all actions are asynchronous, and has thread pools tuned for asynchronous tasks. The use of unmanaged blocking can cause your application to stop responding at very low loads. For details on how to correctly manage thread pools for blocking database calls, see Play&rsquo;s documentation on <a href="https://www.playframework.com/documentation/2.8.x/ThreadPools">thread pools</a>.</li>
</ul><h2 id="Update-the-Read-Side"><a class="section-marker" href="#Update-the-Read-Side">§</a>Update the Read-Side</h2>
<p>We need to transform the events generated by the <a href="PersistentEntity.html">Persistent Entities</a> into database tables that can be queried as illustrated in the previous section. For that we will implement a <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/ReadSideProcessor.html"><code>ReadSideProcessor</code></a>. It will consume events produced by persistent entities and update the database table.</p><h3 id="Event-tags"><a class="section-marker" href="#Event-tags">§</a>Event tags</h3>
<p>In order to consume events from a read-side, the events need to be tagged. All events with a particular tag can be consumed as a sequential, ordered stream of events. Events can be tagged by making them implement the <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/AggregateEvent.html"><code>AggregateEvent</code></a> interface. The tag is defined using the <code>aggregateTag</code> method.</p>
<p>The simplest way to tag events is to give all events for a particular entity the same tag. To do this, define a static tag, and return it from the <code>aggregateTag</code> method of your events:</p>
<pre class="prettyprint"><code class="language-java">public interface BlogEvent extends AggregateEvent&lt;BlogEvent&gt;, Jsonable {

  AggregateEventTag&lt;BlogEvent&gt; BLOG_EVENT_TAG = AggregateEventTag.of(BlogEvent.class);

  @Override
  default AggregateEventTag&lt;BlogEvent&gt; aggregateTag() {
    return BLOG_EVENT_TAG;
  }
}</code></pre>
<p>While this is quite straight forward, it does mean that you can only consume the events one at a time, which may be a bottleneck to scale. If you expect events to only occur in the order of a few times per second, then this might be fine, but if you expect hundreds or thousands of events per second, then you may want to shard your read-side event processing load.</p>
<p>Sharding can be done in two ways, either manually by returning different tags based on information in the event, or automatically by returning a <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/AggregateEventShards.html"><code>AggregateEventShards</code></a> tag, which will tell Lagom to shard the tag used based on the entity&rsquo;s persistence ID. It&rsquo;s important to ensure all the events for the same entity end up with the same tag (and hence in the same shard), otherwise, event processing for that entity may be out of order, since the read side nodes will consume the event streams for their tags at different paces.</p>
<p>When you shard events, you need to decide up front how many shards you want to use. The more shards, the more you can scale your service horizontally across many nodes, however, shards come at a cost, each additional shard increases the number of read side processors that query your database for new events. It is very difficult to change the number of shards without compromising the ordering of events within an entity, so it&rsquo;s best to work out up front what the peak rate of events you expect to need to handle over the lifetime of the system will be, then work out how many nodes you&rsquo;ll need to handle that load, and then use that as the number of shards.</p>
<p>Lagom provides some utilities for helping create sharded tags. To create the sharded tags, define the number of shards in a static variable, as the shards tag, and implement the <code>aggregateTag</code> method to return the shards tag:</p>
<pre class="prettyprint"><code class="language-java">interface BlogEvent extends Jsonable, AggregateEvent&lt;BlogEvent&gt; {

  // will produce tags with shard numbers from 0 to 9
  int NUM_SHARDS = 10;

  AggregateEventShards&lt;BlogEvent&gt; TAG = AggregateEventTag.sharded(BlogEvent.class, NUM_SHARDS);

  @Override
  default AggregateEventShards&lt;BlogEvent&gt; aggregateTag() {
    return TAG;
  }</code></pre>
<p>Now Lagom here will generate a tag name that appends the hash code of the entity ID modulo the number of shards to the class name.</p>
<blockquote>
  <p><strong>Note</strong>: if you&rsquo;re using a JDBC database to store your journal, the number of sharded tags (<code>NumShards</code>) should not be greater then 10. This is due to an existing <a href="https://github.com/dnvriend/akka-persistence-jdbc/issues/168">bug</a> in the plugin. Failing to follow this directive will result in some events being delivered more than once on the read-side or topic producers.</p>
</blockquote><h3 id="Defining-a-read-side-processor"><a class="section-marker" href="#Defining-a-read-side-processor">§</a>Defining a read side processor</h3>
<p>This is how a <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/ReadSideProcessor.html"><code>ReadSideProcessor</code></a> class looks like before filling in the implementation details:</p>
<pre class="prettyprint"><code class="language-java">public class BlogEventProcessor extends ReadSideProcessor&lt;BlogEvent&gt; {

  @Override
  public ReadSideProcessor.ReadSideHandler&lt;BlogEvent&gt; buildHandler() {
    // TODO build read side handler
    return null;
  }

  @Override
  public PSequence&lt;AggregateEventTag&lt;BlogEvent&gt;&gt; aggregateTags() {
    // TODO return the tag for the events
    return null;
  }
}</code></pre>
<p>The first method we&rsquo;ll implement is the <code>aggregateTags</code> method. This method has to return a list of all the tags that our processor will handle - if you return more than one tag, Lagom will shard these tags across your services cluster. To implement this method, simply return the list of all the events for your class:</p>
<pre class="prettyprint"><code class="language-java">@Override
public PSequence&lt;AggregateEventTag&lt;BlogEvent&gt;&gt; aggregateTags() {
  return BlogEvent.TAG.allTags();
}</code></pre>
<p>Now we need to implement the <code>buildHandler</code> method. Let&rsquo;s assume that you have created a component to interact with your preferred database, it provides the following methods:</p>
<pre class="prettyprint"><code class="language-java">public interface MyDatabase {
  /** Create the tables needed for this read side if not already created. */
  CompletionStage&lt;Done&gt; createTables();

  /** Load the offset of the last event processed. */
  CompletionStage&lt;Offset&gt; loadOffset(AggregateEventTag&lt;BlogEvent&gt; tag);

  /** Handle the post added event. */
  CompletionStage&lt;Done&gt; handleEvent(BlogEvent event, Offset offset);
}</code></pre>
<p>The <code>createTables</code> method will create the tables used by the read side processor if they don&rsquo;t already exist - this is completely optional, but may be useful in development and test environments as it alleviates the need for developers to manually set up their environments.</p>
<p>The <code>loadOffset</code> method reads the last <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/Offset.html"><code>Offset</code></a> that was processed by this read side processor for the particular tag. Typically this will be stored in a table that has the tag name and the eventProcessorId as a compound primary key. Offsets come in two varieties, a <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/Offset.Sequence.html"><code>Sequence</code></a> offset represented using a <code>long</code>, and a <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/Offset.TimeBasedUUID.html"><code>TimeBasedUUID</code></a> offset represented using a <code>UUID</code>. Your database will need to be able to persist both of these types. If there is no offset stored for a particular tag, such as when the processor runs for the very first time, then you can return <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/Offset.html#NONE"><code>Offset.NONE</code></a>.</p>
<p>Finally, the <code>handleEvent</code> method is responsible for handling the actual events. It gets passed both the event and the offset, and should persist the offset once the event handling is successful.</p>
<p>Given this interface, we can now implement the <code>buildHandler</code> method:</p>
<pre class="prettyprint"><code class="language-java">@Override
public ReadSideHandler&lt;BlogEvent&gt; buildHandler() {

  return new ReadSideHandler&lt;BlogEvent&gt;() {

    @Override
    public CompletionStage&lt;Done&gt; globalPrepare() {
      return myDatabase.createTables();
    }

    @Override
    public CompletionStage&lt;Offset&gt; prepare(AggregateEventTag&lt;BlogEvent&gt; tag) {
      return myDatabase.loadOffset(tag);
    }

    @Override
    public Flow&lt;Pair&lt;BlogEvent, Offset&gt;, Done, ?&gt; handle() {
      return Flow.&lt;Pair&lt;BlogEvent, Offset&gt;&gt;create()
          .mapAsync(
              1,
              eventAndOffset -&gt;
                  myDatabase.handleEvent(eventAndOffset.first(), eventAndOffset.second()));
    }
  };
}</code></pre>
<p>The <code>globalPrepare</code> method is used for tasks that should only be run once globally. Remember that Lagom will create many read side processors, one for each shard, if each of these are writing to the one table, you only want one of them to attempt to create that table, otherwise it could create race conditions in your database. Lagom will ensure that the <code>globalPrepare</code> method executes at least once before any read side processing begins. It may be executed multiple times, particularly when your cluster restarts, but those executions will only ever happen one at a time. If the <code>globalPrepare</code> fails, Lagom will retry, backing off exponentially on subsequent failures, until it succeeds.</p>
<p>The <code>prepare</code> method is used to load the last offset, and is useful for any other things that need to be prepared, such as optimizing update statements, before processing begins. It will be executed once per read side processor.</p>
<p>The <code>handle</code> method must return an Akka streams <code>Flow</code> to handle the event stream. Typically it will use <code>mapAsync</code>, with a parallelism of 1, to handle the events.</p><h3 id="Registering-your-read-side-processor"><a class="section-marker" href="#Registering-your-read-side-processor">§</a>Registering your read-side processor</h3>
<p>Once you&rsquo;ve created your read-side processor, you need to register it with Lagom. This is done using the <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/ReadSide.html"><code>ReadSide</code></a> component:</p>
<pre class="prettyprint"><code class="language-java">@Inject
public BlogServiceImpl(PersistentEntityRegistry persistentEntityRegistry, ReadSide readSide) {
  this.persistentEntityRegistry = persistentEntityRegistry;

  readSide.register(BlogEventProcessor.class);
}</code></pre><h2 id="Raw-Stream-of-Events"><a class="section-marker" href="#Raw-Stream-of-Events">§</a>Raw Stream of Events</h2>
<p>There is another tool that can be used if you want more flexible event processing. You can get a stream of the persistent events directly from Lagom with the <code>eventStream</code> method of the <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/PersistentEntityRegistry.html">PersistentEntityRegistry</a>.</p>
<pre class="prettyprint"><code class="language-java">public ServiceCall&lt;NotUsed, Source&lt;PostSummary, ?&gt;&gt; newPosts() {
  final PartialFunction&lt;BlogEvent, PostSummary&gt; collectFunction =
      new PFBuilder&lt;BlogEvent, PostSummary&gt;()
          .match(
              BlogEvent.PostAdded.class,
              evt -&gt; new PostSummary(evt.getPostId(), evt.getContent().getTitle()))
          .build();

  return request -&gt; {
    Source&lt;PostSummary, ?&gt; stream =
        persistentEntityRegistry
            .eventStream(BlogEvent.TAG.forEntityId(&quot;&quot;), Offset.NONE)
            .map(pair -&gt; pair.first())
            .collect(collectFunction);
    return CompletableFuture.completedFuture(stream);
  };
}</code></pre>
<p>The <code>eventStream</code> method takes the event class that implements the <code>AggregateEventType</code> and an optional offset, which is the starting point of the stream. It returns a <code>Source</code> of <code>Pair</code> elements, which contains the event and the associated offset.</p>
<p>This stream will never complete, unless there is failure from retrieving the events from the database. It will continue to deliver new events as they are persisted.</p>
<p>Each such stream of events will continuously generate queries to the persistent entity implementation (eg, Cassandra) to fetch new events and therefore this tool should be used carefully. Do not run too many such streams. It should typically not be used for service calls invoked by unknown number of clients, but it can be useful for a limited number of background processing jobs.</p><h2 id="Refactoring-Consideration"><a class="section-marker" href="#Refactoring-Consideration">§</a>Refactoring Consideration</h2>
<p>If you use a class name of a event type as the aggregate tag in <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/AggregateEventTag.html">AggregateEventTag</a> you have to retain the original tag if you change the event class name because this string is part of the stored event data. <code>AggregateEventTag</code> has a factory method (and constructor) with a <code>String tag</code> parameter for this purpose. Instead of using a class name as tag identifier you can consider to use a string tag up-front. The tag should be unique among the event types of the service.</p><h2 id="Configuration"><a class="section-marker" href="#Configuration">§</a>Configuration</h2>
<p>The default configuration should be good starting point, and the following settings may later be amended to customize the behavior if needed.</p>
<pre class="prettyprint"><code class="language-conf">lagom.persistence.read-side {

  # how long should we wait when retrieving the last known offset
  offset-timeout = 5s

  # Exponential backoff for failures in ReadSideProcessor
  failure-exponential-backoff {
    # minimum (initial) duration until processor is started again
    # after failure
    min = 3s

    # the exponential back-off is capped to this duration
    max = 30s

    # additional random delay is based on this factor
    random-factor = 0.2
  }

  # The amount of time that a node should wait for the global prepare callback to execute
  global-prepare-timeout = 20s

  # Specifies that the read side processors should run on cluster nodes with a specific role.
  # If the role is not specified (or empty) all nodes in the cluster are used.
  run-on-role = &quot;&quot;

  # The Akka dispatcher to use for read-side actors and tasks.
  use-dispatcher = &quot;lagom.persistence.dispatcher&quot;

  # Enables capture and reporting of metrics on the Read-Side. The metrics
  # reporting enforces consuming events one at a time.
  projection-metrics = on
}</code></pre><h2 id="Underlying-Implementation"><a class="section-marker" href="#Underlying-Implementation">§</a>Underlying Implementation</h2>
<p>The <code>eventStream</code> of the <code>PersistentEntityRegistry</code> is also implemented by the <code>eventsByTag</code> query.</p>
                </article>

                
                    
                        <nav class="next-links">
                            <strong>Next:</strong>
                            <ul>
                            
                                <li><a href="ReadSideCassandra.html">Cassandra Read-Side Support</a>
                                </li>
                            
                                <li><a href="ReadSideRDBMS.html">Relational Database Read-Side Support</a>
                                </li>
                            
                            </ul>
                        </nav>
                    
                

                
                    <p class="edit-source">Found an error in this documentation? The source code for this page can be found
                        <a href="https://github.com/lagom/lagom/edit/1.6.x/docs/manual/java/guide/cluster/ReadSide.md">here</a>. Please feel free to edit and contribute a pull request. </p>
                
            </div>
            <aside class="small-12 large-4 columns">
                <nav class="side-menu">

                    <input type="search" id="cross-docs-search" placeholder="Search..." />

                    <label for="docs-version">Version:</label>
                    <select id="docs-version">
                    
                        <option value="/documentation/1.0.x/java/ReadSide.html" >1.0.x</option>
                    
                        <option value="/documentation/1.1.x/java/ReadSide.html" >1.1.x</option>
                    
                        <option value="/documentation/1.2.x/java/ReadSide.html" >1.2.x</option>
                    
                        <option value="/documentation/1.3.x/java/ReadSide.html" >1.3.x</option>
                    
                        <option value="/documentation/1.4.x/java/ReadSide.html" >1.4.x</option>
                    
                        <option value="/documentation/1.5.x/java/ReadSide.html" >1.5.x</option>
                    
                        <option value="/documentation/1.6.x/java/ReadSide.html" 
                            selected="selected">1.6.x</option>
                    
                        <option value="/documentation/current/java/ReadSide.html" >current</option>
                    
                        <option value="/documentation/latest/java/ReadSide.html" >latest</option>
                    
                    </select>

                    <a href="/documentation/1.6.x/java/api/index.html" class="api-docs">
                        API Documentation</a>

                    
                        <h3>Writing persistent and clustered services</h3>
                        <ul>
                        
                            
                                <li><a href="UsingAkkaPersistenceTyped.html">Domain Modelling with Akka Persistence Typed</a></li>
                            
                        
                            
                                <li><a href="MigratingToAkkaPersistenceTyped.html"> Migrating to Akka Persistence Typed</a></li>
                            
                        
                            
                                <li><a href="PersistentEntity.html">Persistent Entity (classic)</a></li>
                            
                        
                            
                                <li><a href="ChoosingADatabase.html">Choosing a Database</a></li>
                            
                        
                            
                                <li><a href="PersistentEntityCassandra.html">Cassandra Setup</a></li>
                            
                        
                            
                                <li><a href="PersistentEntityRDBMS.html">Relational Database Setup</a></li>
                            
                        
                            
                                <li class="current-page"><a href="ReadSide.html">Persistent Read-Side</a></li>
                            
                        
                            
                                <li><a href="ReadSideCassandra.html">Cassandra Read-Side Support</a></li>
                            
                        
                            
                                <li><a href="ReadSideRDBMS.html">Relational Database Read-Side Support</a></li>
                            
                        
                            
                                <li><a href="ReadSideJDBC.html">JDBC Read-Side Support</a></li>
                            
                        
                            
                                <li><a href="ReadSideJPA.html">JPA Read-Side Support</a></li>
                            
                        
                            
                                <li><a href="PubSub.html">Publish-Subscribe</a></li>
                            
                        
                            
                                <li><a href="Cluster.html">Cluster</a></li>
                            
                        
                            
                                <li><a href="Serialization.html">Serialization</a></li>
                            
                        
                            
                                <li><a href="Projections.html">Projections</a></li>
                            
                        
                        </ul>
                    
                        <h3>Lagom reference guide</h3>
                        <ul>
                        
                            
                                <li><a href="ReferenceGuide.html">Reference Guide</a></li>
                            
                        
                            
                                <li><a href="LagomBuild.html">Configuring builds and the development environment</a></li>
                            
                        
                            
                                <li><a href="DevEnvironment.html">Running Lagom in development</a></li>
                            
                        
                            
                                <li><a href="ServiceDescriptors.html">Writing Lagom services</a></li>
                            
                        
                            
                                <li class="current-page"><a href="UsingAkkaPersistenceTyped.html">Writing persistent and clustered services</a></li>
                            
                        
                            
                                <li><a href="MessageBroker.html">Decouple services with a message broker</a></li>
                            
                        
                            
                                <li><a href="ProductionOverview.html">Running Lagom in production</a></li>
                            
                        
                            
                                <li><a href="Logging.html">Logging</a></li>
                            
                        
                            
                                <li><a href="Akka.html">Advanced topics</a></li>
                            
                        
                        </ul>
                    
                        <h3>Java Home</h3>
                        <ul>
                        
                            
                                <li><a href="Home.html">Home</a></li>
                            
                        
                            
                                <li><a href="WhatIsLagom.html">Welcome to Lagom</a></li>
                            
                        
                            
                                <li><a href="IntroGetStarted.html">Getting started with Lagom</a></li>
                            
                        
                            
                                <li><a href="CoreConcepts.html">Lagom core concepts</a></li>
                            
                        
                            
                                <li class="current-page"><a href="ReferenceGuide.html">Lagom reference guide</a></li>
                            
                        
                            
                                <li><a href="Highlights16.html">Lagom releases</a></li>
                            
                        
                        </ul>
                    
                </nav>
            </aside>
        </div>
    </div>


                    <footer>
                        <section class="fw-wrapper lb-grey-dkr support">
                            <div class="row">
                                <div class="small-12 medium-6 columns">
                                    <svg class="svg-icon svg-icon-chat" version="1.1" id="Chat" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" style="enable-background:new 0 0 20 20;" xml:space="preserve">
<path fill="#ffffff" d="M5.8,12.2V6H2C0.9,6,0,6.9,0,8v6c0,1.1,0.9,2,2,2h1v3l3-3h5c1.1,0,2-0.9,2-2v-1.82c-0.064,0.014-0.132,0.021-0.2,0.021h-7
	V12.2z M18,1H9C7.9,1,7,1.9,7,3v8h7l3,3v-3h1c1.1,0,2-0.899,2-2V3C20,1.9,19.1,1,18,1z"/>
</svg>

                                    <h3>Community support</h3>
                                    <ul>
                                        <li><a href="https://discuss.lagomframework.com">Discuss Lagom</a></li>
                                        <li><a href="https://stackoverflow.com/questions/tagged/lagom">Stack Overflow</a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 columns">
                                    <svg class="svg-icon svg-icon-lb-icon-reverse" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 302 262">
    <title>lightbend-icon</title>
    <path  fill="#ffffff" d="M1,195v56a10,10,0,0,0,10,10H291a10,10,0,0,0,10-10V195a557.85,557.85,0,0,1-150,20A557.85,557.85,0,0,1,1,195Z" />
    <path  fill="#ffffff" d="M291,1H11A10,10,0,0,0,1,11V176a539.94,539.94,0,0,0,150,21,539.94,539.94,0,0,0,150-21V11A10,10,0,0,0,291,1Z" />
</svg>

                                    <h3>Professional support</h3>
                                    <ul>
                                        <li><a href="https://www.lightbend.com/services/expert-support">Lightbend Subscription</a></li>
                                        <li><a href="https://www.lightbend.com/services/training">Training</a></li>
                                        <li><a href="https://www.lightbend.com/services/consulting">Consulting</a></li>
                                    </ul>
                                </div>
                            </div>
                        </section>

                        <section class="fw-wrapper lb-grey links">
                            <div class="row">
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Lagom</h3>
                                    <ul class="no-bullet">
                                        <li><a href="/get-started.html">Try Lagom</a></li>
                                        <li><a href="/blog">Blog</a></li>
                                        <li><a href="/documentation/">Documentation</a></li>
                                        <li><a href="/faq">FAQ</a></li>
                                        <li><a href="/support">Support</a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Community links</h3>
                                    <ul>
                                        <li><a href="https://www.eventbrite.com/directory/?q=lagom&amp;loc=Worldwide">Events <em>via Eventbrite</em></a></li>
                                        <li><a href="http://www.indeed.com/jobs?q=%22lagom%22&amp;l=">Jobs <em>via Indeed</em></a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Code &amp; contribution</h3>
                                    <ul>
                                        <li><a href="https://github.com/lagom/lagom/issues">Bug tracker <em>GitHub</em></a></li>
                                        <li><a href="/get-involved.html">Get involved</a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Social networks</h3>
                                    <ul>
                                        <li><a href="https://twitter.com/lagom"><span>Twitter</span></a></li>
                                    </ul>
                                </div>
                            </div>
                        </section>

                        <section class="fw-wrapper lgm-purple-dkr credits">
                            <div class="row">
                                <div class="small-12 medium-3 columns">
                                    <a href="/" class="logo"><img src="/images/logos/lagom-reverse.svg"></a>
                                </div>
                                <div class="small-12 medium-3 columns">
                                    <a href="https://www.lightbend.com" class="partner"><img src="/images/logos/lightbend-reverse.svg"></a>
                                </div>
                                <div class="small-12 medium-6 columns">
                                    <p>Lagom is released under the Apache 2 License</p>
                                </div>
                            </div>
                            <div class="row lb-legal">
                                <div class="small-12 columns">
                                    <p>
                                        &copy; Lightbend 2018 | 
                                        <a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> | 
                                        <a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> | 
                                        <a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> | 
                                        <a href="/cookie.html">Cookie Listing</a> | 
                                        <a class="optanon-toggle-display">Cookie Settings</a>
                                    </p>
                                </div>
                            </div>
                        </section>

                    </footer>

                </div>
            </div>
        </div>
    </body>
    <script src="/8be04369559d94442613cb3d5ea4e194d42e8a40-all-scripts-concat.js"></script>
    
     
    <script type="text/javascript" src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
        <!-- Cross-site search. This is using Algolia's autocomplete.js  -->
    <script>
            var clientLagom = algoliasearch('BH4D9OD16A', '77ef1e29e6bddfca861f7a42cc51725e');
            var lagomIndex = clientLagom.initIndex('lagomframework');

            var displayValue = function (suggestion, level) {
                if (level === 0)
                    return suggestion._highlightResult.hierarchy.lvl0.value;
                if (suggestion._highlightResult.hierarchy['lvl' + level] !== undefined) {
                    return suggestion._highlightResult.hierarchy['lvl' + level].value ;
                } else {
                    return displayValue(suggestion, level - 1) ;
                }
            };
            var displaySnippet = function (suggestion) {
                if (typeof suggestion._snippetResult !== 'undefined') {
                    return '<div class="algolia-docsearch-suggestion--text">' + suggestion._snippetResult.content.value + '</div>'
                } else {
                    return ''
                }
            }

            var wrap = function (content, wrapper) {
                if (typeof wrapper !== 'undefined') {
                    return '<span class=' + wrapper + '>' + content + '</span>';
                } else {
                    return content;
                }
            }

            var buildIndexSettings = function (_indexObj, _hitsPerPage, _faceFilters, title, useFooter, wrapper) {
                var _header = wrap('<span class="algolia-docsearch-suggestion algolia-docsearch-suggestion__main algolia-docsearch-suggestion__secondary algolia-docsearch-suggestion--category-header ">' + title + '</span>', wrapper);
                var _templates = {
                    header: _header,
                    suggestion: function (suggestion) {
                        var suggestionHtml = '<div class="algolia-docsearch-suggestion algolia-docsearch-suggestion__secondary" style="white-space: normal;">' +
                                '<div class="algolia-docsearch-suggestion--wrapper">' +
                                '<div class="algolia-docsearch-suggestion--subcategory-column ">' +
                                '<span class="algolia-docsearch-suggestion--subcategory-column-text">' + displayValue(suggestion, 0) + '</span>' +
                                '</div>' +
                                '<div class="algolia-docsearch-suggestion--content">' +
                                '<div class="algolia-docsearch-suggestion--subcategory-inline ">' + displayValue(suggestion, 1) + '</div>' +
                                '<div class="algolia-docsearch-suggestion--title algolia-docsearch-suggestion--duplicate-content">' + displayValue(suggestion, 2) + '</div>' +
                                displaySnippet(suggestion) +
                                '</div>' +
                                '</div>' +
                                '</div>';
                        return wrap(suggestionHtml, wrapper)
                    }
                };
                if (useFooter) {
                    _templates['footer'] = '<div class="algolia-docsearch-footer"><a class="algolia-docsearch-footer--logo" href="https://www.algolia.com/docsearch">Algolia</a></div>';
                }

                return {
                    source: autocomplete.sources.hits(
                            _indexObj,
                            {hitsPerPage: _hitsPerPage, facetFilters: _faceFilters}
                    )
                    ,
                    templates: _templates
                };

            };

            var lagomFacetFilters = ['version:current'];

            var useScalaFacetFilter = window.location.href.split('/').includes("scala");
            if (useScalaFacetFilter) {
                lagomFacetFilters.push('language:scala');
            } else {
                lagomFacetFilters.push('language:java');
            }


            autocomplete('#cross-docs-search',
                    {hint: false},
                    [
                        buildIndexSettings(lagomIndex, 10, lagomFacetFilters, "Lagom Documentation", false)
                    ]
            ).on('autocomplete:selected', function (event, suggestion, dataset) {
                location.href = suggestion.url;
            });
    </script>


    

    <script type="text/plain" class="optanon-category-2">
  		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  		ga('create', 'UA-84991267-1', 'auto');
  		ga('send', 'pageview');

        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-MT586J3');
	</script>
</html>

